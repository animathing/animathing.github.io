<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Music Studio | Neon</title>

    <!-- Meta Tags untuk SEO dan Social Sharing -->
    <meta name="description" content="Ciptakan musik dengan kekuatan AI. Bangun ketukan, buat melodi, dan jelajahi suara baru di Neon AI Music Studio.">
    <meta property="og:title" content="AI Music Studio | Neon"/>
    <meta property="og:description" content="Ciptakan musik dengan kekuatan AI. Bangun ketukan, buat melodi, dan jelajahi suara baru."/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://placehold.co/1200x630/0a0a0a/ffffff?text=AI+Music+Studio"/>
    <meta property="og:url" content="https://example.com"/>
    <meta property="twitter:card" content="summary_large_image"/>
    <meta property="twitter:image" content="https://placehold.co/1200x630/0a0a0a/ffffff?text=AI+Music+Studio"/>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Orbitron -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">

    <!-- Tone.js untuk Audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <style>
        /* Custom Styles & Tailwind Config */
        body {
            font-family: 'Orbitron', sans-serif;
            background-color: #0a0a0a;
            color: #e0e0e0;
            overflow-x: hidden;
        }

        /* Custom glow effect */
        .glow {
            box-shadow: 0 0 5px #00f, 0 0 10px #00f, 0 0 15px #00f;
        }
        .glow-pink {
            box-shadow: 0 0 5px #f0f, 0 0 10px #f0f, 0 0 15px #f0f;
        }

        /* Custom kelas untuk transisi */
        .btn {
            @apply px-5 py-3 rounded-lg font-bold text-white uppercase tracking-wider transition-all duration-300 ease-in-out;
        }
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-500 hover:shadow-lg hover:shadow-blue-500/50;
        }
        .btn-secondary {
            @apply bg-pink-600 hover:bg-pink-500 hover:shadow-lg hover:shadow-pink-500/50;
        }
        .btn:disabled {
            @apply bg-gray-700 text-gray-500 cursor-not-allowed hover:shadow-none;
        }
        
        /* Gaya untuk sampler pad */
        .sampler-pad {
            @apply w-full h-24 sm:h-28 md:h-32 bg-gray-800/50 border-2 border-blue-500/50 rounded-lg cursor-pointer flex items-center justify-center text-lg font-bold transition-all duration-150 ease-in-out transform hover:scale-105 hover:bg-blue-600/70;
            backdrop-filter: blur(5px);
        }
        .sampler-pad.active {
            @apply scale-105 bg-blue-500 shadow-lg shadow-blue-400/50;
            transform: scale(1.05) translateY(-2px);
        }
        
        /* Spinner untuk loading */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: #00aaff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Visualizer bar */
        .visualizer-bar {
            @apply w-full bg-blue-500/80 rounded-t-sm transition-all duration-100 ease-out;
            box-shadow: 0 0 3px #00f, 0 0 5px #00f;
        }
    </style>
</head>
<body class="min-h-screen bg-black/90 flex items-center justify-center p-4">

    <div id="app-container" class="w-full max-w-5xl mx-auto bg-gray-900/60 border border-gray-700 rounded-2xl shadow-2xl shadow-blue-500/20 p-4 sm:p-6 md:p-8 space-y-8">
        
        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between items-center gap-4 border-b border-gray-700 pb-6">
            <h1 class="text-3xl md:text-4xl font-black tracking-wider text-white uppercase">
                AI <span class="text-blue-400">Music</span> Studio
            </h1>
            <div id="master-controls" class="flex items-center gap-3">
                <label for="volume" class="font-semibold">VOLUME</label>
                <input type="range" id="volume" min="0" max="1" value="0.5" step="0.01" class="w-32 cursor-pointer"/>
            </div>
        </header>

        <main class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Kolom Kiri: Sampler & Visualizer -->
            <div class="space-y-8">
                <!-- Instrument Sampler -->
                <section id="instrument-sampler">
                    <h2 class="text-2xl font-bold mb-4 text-center sm:text-left">SOUND SAMPLER</h2>
                    <div id="sampler-pads" class="grid grid-cols-3 gap-3">
                        <!-- Sample pads akan dibuat oleh JS -->
                    </div>
                </section>
                 <!-- Visualizer -->
                <section id="visualizer-section">
                    <h2 class="text-2xl font-bold mb-4 text-center sm:text-left">BEAT LIGHTS</h2>
                    <div id="visualizer-container" class="h-24 bg-gray-800/50 rounded-lg p-2 flex items-end justify-between gap-1 border border-gray-700">
                         <!-- Visualizer bar akan dibuat oleh JS -->
                    </div>
                </section>
            </div>

            <!-- Kolom Kanan: AI Generator & Kontrol -->
            <div class="space-y-8">
                 <!-- AI Song Generator -->
                <section id="ai-song-generator" class="bg-gray-800/50 border border-gray-700 p-6 rounded-lg">
                    <h2 class="text-2xl font-bold mb-4">AUTOMATIC SONG MAKER</h2>
                    <div class="space-y-4">
                        <label for="ai-prompt" class="block">Deskripsikan ide lagu Anda:</label>
                        <input type="text" id="ai-prompt" placeholder="contoh: chill lofi hip hop" class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="generate-song-btn" class="btn btn-primary w-full">GENERATE BEAT</button>
                        <div id="loading-indicator" class="hidden items-center justify-center gap-3 text-lg">
                            <span>Generating...</span>
                            <div class="spinner"></div>
                        </div>
                         <p id="error-message" class="text-red-400 text-center"></p>
                    </div>
                    <div id="generated-song-info" class="mt-4 text-center">
                        <h3 id="song-title" class="text-xl font-bold text-blue-300"></h3>
                        <p id="song-bpm" class="text-md text-gray-400"></p>
                    </div>
                </section>

                <!-- Kontrol Playback -->
                <section id="sequencer-controls" class="bg-gray-800/50 border border-gray-700 p-6 rounded-lg">
                    <h2 class="text-2xl font-bold mb-4">PLAYBACK</h2>
                    <div class="flex flex-col sm:flex-row gap-4">
                         <button id="play-sequence-btn" class="btn btn-secondary flex-1" disabled>PLAY AI BEAT</button>
                         <button id="stop-sequence-btn" class="btn bg-gray-700 hover:bg-red-600 flex-1" disabled>STOP</button>
                    </div>
                     <div class="flex items-center justify-center mt-4">
                        <input type="checkbox" id="loop-sequence" checked class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <label for="loop-sequence" class="ml-2">LOOP</label>
                    </div>
                </section>
            </div>
        </main>

        <!-- Footer -->
        <footer class="text-center border-t border-gray-700 pt-6 mt-4">
            <p class="text-gray-500">Neon AI Music Studio</p>
        </footer>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Inisialisasi Tone.js setelah interaksi pengguna
        const initAudio = async () => {
            if (Tone.context.state !== 'running') {
                await Tone.start();
                console.log("AudioContext dimulai");
            }
        };
        document.body.addEventListener('click', initAudio, { once: true });

        // Referensi Elemen DOM
        const volumeControl = document.getElementById('volume');
        const samplerPadsContainer = document.getElementById('sampler-pads');
        const generateBtn = document.getElementById('generate-song-btn');
        const playBtn = document.getElementById('play-sequence-btn');
        const stopBtn = document.getElementById('stop-sequence-btn');
        const loopCheckbox = document.getElementById('loop-sequence');
        const loadingIndicator = document.getElementById('loading-indicator');
        const songTitleEl = document.getElementById('song-title');
        const songBpmEl = document.getElementById('song-bpm');
        const visualizerContainer = document.getElementById('visualizer-container');
        const errorMessageEl = document.getElementById('error-message');

        // Pengaturan Audio
        Tone.Destination.volume.value = Tone.gainToDb(0.5);
        
        // --- 1. Sound Sampler ---
        const samplerSynths = {};
        const samplerNotes = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4'];
        
        samplerNotes.forEach(note => {
            samplerSynths[note] = new Tone.Synth({
                oscillator: { type: 'fmsquare' },
                envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.8 }
            }).toDestination();
            const pad = document.createElement('div');
            pad.classList.add('sampler-pad');
            pad.textContent = note;
            pad.dataset.note = note;
            samplerPadsContainer.appendChild(pad);
            pad.addEventListener('mousedown', () => {
                if (Tone.context.state !== 'running') return;
                samplerSynths[note].triggerAttackRelease(note, '8n');
                pad.classList.add('active');
            });
            pad.addEventListener('mouseup', () => pad.classList.remove('active'));
            pad.addEventListener('mouseleave', () => pad.classList.remove('active'));
        });

        // --- 2. Visualizer ---
        const numBars = 24;
        for (let i = 0; i < numBars; i++) {
            const bar = document.createElement('div');
            bar.classList.add('visualizer-bar');
            bar.style.height = '1%';
            visualizerContainer.appendChild(bar);
        }
        const visualizerBars = visualizerContainer.querySelectorAll('.visualizer-bar');
        const meter = new Tone.Meter();
        Tone.Destination.connect(meter);
        function updateVisualizer() {
            const level = Tone.Transport.state === 'started' ? Tone.dbToGain(meter.getValue()) : 0;
            visualizerBars.forEach((bar, i) => {
                const height = Math.max(1, level * 100 * (1 - Math.abs(i - numBars / 2) / (numBars / 1.5)) * 2);
                bar.style.height = `${height}%`;
            });
            requestAnimationFrame(updateVisualizer);
        }
        updateVisualizer();

        // --- 3. AI Song Generator & Sequencer ---
        let currentSequences = [];
        let kick, snare, synth;

        const stopAndClearMusic = () => {
            if (Tone.Transport.state === 'started') {
                Tone.Transport.stop();
            }
            currentSequences.forEach(seq => {
                seq.stop();
                seq.dispose();
            });
            currentSequences = [];
            if(kick) kick.dispose();
            if(snare) snare.dispose();
            if(synth) synth.dispose();
        }

        generateBtn.addEventListener('click', async () => {
            const userPrompt = document.getElementById('ai-prompt').value.trim();
            if (!userPrompt) {
                errorMessageEl.textContent = "Mohon masukkan deskripsi lagu.";
                return;
            }
            await initAudio(); // Pastikan audio context aktif

            loadingIndicator.style.display = 'flex';
            generateBtn.disabled = true;
            playBtn.disabled = true;
            stopBtn.disabled = true;
            errorMessageEl.textContent = "";
            songTitleEl.textContent = "";
            songBpmEl.textContent = "";

            stopAndClearMusic();

            try {
                // Konfigurasi untuk Gemini API
                const apiKey = ""; // Disediakan oleh environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const systemPrompt = `You are a music generator assistant. Based on the user's prompt, create a simple 16-step musical pattern. Respond ONLY with a JSON object.
                The JSON must have these properties: "bpm" (number between 80-160), "synthType" (string, one of: "fmsquare", "sawtooth", "triangle8", "pulse"), "kickPattern" (array of 16 numbers, 1 for a hit, 0 for a rest), "snarePattern" (array of 16 numbers), and "synthPattern" (array of 16 strings, containing musical notes like "C4", "G3", or null for a rest).
                Example for "funky": { "bpm": 120, "synthType": "fmsquare", "kickPattern": [1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], "snarePattern": [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0], "synthPattern": ["C4", null, "G4", "C4", null, "A4", null, "G4", "F4", null, "C4", null, null, "D4", "E4", null] }`;

                const payload = {
                    contents: [{
                        role: "user",
                        parts: [{ text: `System prompt: ${systemPrompt}. User prompt: "${userPrompt}"` }]
                    }],
                    generationConfig: {
                        responseMimeType: "application/json",
                    }
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.statusText}`);
                }

                const result = await response.json();
                
                if (!result.candidates || !result.candidates[0].content.parts[0].text) {
                     throw new Error("Respon AI tidak valid.");
                }

                const musicData = JSON.parse(result.candidates[0].content.parts[0].text);

                // Membuat instrumen
                kick = new Tone.MembraneSynth({ pitchDecay: 0.02, octaves: 6, oscillator: { type: "sine" }, envelope: { attack: 0.001, decay: 0.5, sustain: 0.01, release: 0.4, attackCurve: "exponential" } }).toDestination();
                snare = new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0 } }).toDestination();
                synth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: musicData.synthType || 'fmsquare' } }).toDestination();

                // Membuat sekuens
                const kickSequence = new Tone.Sequence((time, value) => {
                    if (value) kick.triggerAttack("C1", time);
                }, musicData.kickPattern, "16n").start(0);

                const snareSequence = new Tone.Sequence((time, value) => {
                    if (value) snare.triggerAttack(time);
                }, musicData.snarePattern, "16n").start(0);

                const synthSequence = new Tone.Sequence((time, note) => {
                    if (note) synth.triggerAttackRelease(note, "16n", time);
                }, musicData.synthPattern, "16n").start(0);
                
                currentSequences = [kickSequence, snareSequence, synthSequence];
                loopCheckbox.dispatchEvent(new Event('change')); // Terapkan status loop

                Tone.Transport.bpm.value = musicData.bpm;
                Tone.Transport.start();

                // Update UI
                songTitleEl.textContent = `"${userPrompt}"`;
                songBpmEl.textContent = `${musicData.bpm} BPM`;
                playBtn.textContent = 'PAUSE AI BEAT';

            } catch (error) {
                console.error("Error generating song:", error);
                errorMessageEl.textContent = "Gagal membuat musik. Coba lagi.";
            } finally {
                loadingIndicator.style.display = 'none';
                generateBtn.disabled = false;
                playBtn.disabled = false;
                stopBtn.disabled = false;
            }
        });

        playBtn.addEventListener('click', () => {
            if (currentSequences.length === 0) return;
            if (Tone.Transport.state === 'started') {
                Tone.Transport.pause();
                playBtn.textContent = 'PLAY AI BEAT';
            } else {
                Tone.Transport.start();
                playBtn.textContent = 'PAUSE AI BEAT';
            }
        });

        stopBtn.addEventListener('click', () => {
             if (currentSequences.length === 0) return;
             Tone.Transport.stop();
             playBtn.textContent = 'PLAY AI BEAT';
        });

        loopCheckbox.addEventListener('change', () => {
            Tone.Transport.loop = loopCheckbox.checked;
            Tone.Transport.loopEnd = '1m'; // Loop selama 1 measure (16 steps)
        });
        
        // --- 4. Kontrol Volume Master ---
        volumeControl.addEventListener('input', (e) => {
            const volumeDb = Tone.gainToDb(parseFloat(e.target.value));
            Tone.Destination.volume.rampTo(volumeDb, 0.1);
        });
    });
    </script>
</body>
</html>
